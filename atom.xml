<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[OutMan の Blog]]></title>
  <subtitle><![CDATA[拒绝一切自费活动]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="http://blog.tanchao.org/"/>
  <updated>2016-01-21T06:39:37.000Z</updated>
  <id>http://blog.tanchao.org/</id>
  
  <author>
    <name><![CDATA[OutMan]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[试用 MySQL Inception]]></title>
    <link href="http://blog.tanchao.org/2016/01/05/mysql-inception-web/"/>
    <id>http://blog.tanchao.org/2016/01/05/mysql-inception-web/</id>
    <published>2016-01-05T02:52:50.000Z</published>
    <updated>2016-01-21T06:39:37.000Z</updated>
    <content type="html"><![CDATA[<p>Inception是集审核、执行、回滚于一体的一个自动化运维系统，它是根据MySQL代码修改过来的，用它可以很明确的，详细的，准确的审核MySQL的SQL语句，它的工作模式和MySQL完全相同，可以直接使用MySQL客户端来连接，Inception是一款自动化运维的利器，有别与现在各个公司使用的方式，使用Inception，将会给DBA带来最大的便利性，将DBA从繁冗的工作中解放出来，做一些更多的自动化工作，或者从架构方面研究如何更大程度的保证数据库的高可用等等。</p>
<a id="more"></a>
<h3 id="u5B89_u88C5_u4F9D_u8D56_u6761_u4EF6"><a href="#u5B89_u88C5_u4F9D_u8D56_u6761_u4EF6" class="headerlink" title="安装依赖条件"></a>安装依赖条件</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="operator"><span class="keyword">install</span> -y cmake ncurses-devel openssl-devel bison-devel gcc-<span class="keyword">c</span>++</span></span><br></pre></td></tr></table></figure>
<h3 id="u7F16_u8BD1_inception"><a href="#u7F16_u8BD1_inception" class="headerlink" title="编译 inception"></a>编译 inception</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone http<span class="variable">s:</span>//github.<span class="keyword">com</span>/mysql-inception/inception.git</span><br><span class="line"><span class="keyword">cd</span> inception</span><br><span class="line">./inception_build.<span class="keyword">sh</span> <span class="keyword">debug</span></span><br></pre></td></tr></table></figure>
<p>每次如果出错之后，需要把编译目录删除掉<code>rm -rf debug</code>，重新执行，不然会执行出错。</p>
<h3 id="u914D_u7F6E_inception"><a href="#u914D_u7F6E_inception" class="headerlink" title="配置 inception"></a>配置 inception</h3><p>新建 inc.cnf 文件，粘贴下面的内容</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[inception]</span></span><br><span class="line"><span class="setting">general_log=<span class="value"><span class="number">1</span></span></span></span><br><span class="line"><span class="setting">general_log_file=<span class="value">inception.log</span></span></span><br><span class="line"><span class="setting">port=<span class="value"><span class="number">6669</span></span></span></span><br><span class="line"><span class="setting">socket=<span class="value">/自己目录，请自行修改/inc.socket</span></span></span><br><span class="line"><span class="setting">character-set-client-handshake=<span class="value"><span class="number">0</span></span></span></span><br><span class="line"><span class="setting">character-set-server=<span class="value">utf8</span></span></span><br><span class="line"><span class="setting">inception_remote_system_password=<span class="value">root</span></span></span><br><span class="line"><span class="setting">inception_remote_system_user=<span class="value">wzf1</span></span></span><br><span class="line"><span class="setting">inception_remote_backup_port=<span class="value"><span class="number">3306</span></span></span></span><br><span class="line"><span class="setting">inception_remote_backup_host=<span class="value"><span class="number">127.0</span>.<span class="number">0.1</span></span></span></span><br><span class="line"><span class="setting">inception_support_charset=<span class="value">utf8mb4</span></span></span><br><span class="line"><span class="setting">inception_enable_nullable=<span class="value"><span class="number">0</span></span></span></span><br><span class="line"><span class="setting">inception_check_primary_key=<span class="value"><span class="number">1</span></span></span></span><br><span class="line"><span class="setting">inception_check_column_comment=<span class="value"><span class="number">1</span></span></span></span><br><span class="line"><span class="setting">inception_check_table_comment=<span class="value"><span class="number">1</span></span></span></span><br><span class="line"><span class="setting">inception_osc_min_table_size=<span class="value"><span class="number">1</span></span></span></span><br><span class="line"><span class="setting">inception_osc_bin_dir=<span class="value">/data/temp</span></span></span><br><span class="line"><span class="setting">inception_osc_chunk_time=<span class="value"><span class="number">0.1</span></span></span></span><br><span class="line"><span class="setting">inception_enable_blob_type=<span class="value"><span class="number">1</span></span></span></span><br><span class="line"><span class="setting">inception_check_column_default_value=<span class="value"><span class="number">1</span></span></span></span><br><span class="line"><span class="setting">inception_check_autoincrement_name=<span class="value"><span class="number">0</span></span></span></span><br><span class="line"><span class="setting">inception_enable_identifer_keyword=<span class="value"><span class="number">1</span></span></span></span><br><span class="line"><span class="setting">inception_enable_sql_statistic=<span class="value"><span class="number">1</span></span></span></span><br></pre></td></tr></table></figure>
<p>点击下面的链接查看更多的参数和选项</p>
<p><a href="http://mysql-inception.github.io/inception-document/option/" target="_blank" rel="external">http://mysql-inception.github.io/inception-document/option/</a></p>
<h3 id="u542F_u52A8_inception"><a href="#u542F_u52A8_inception" class="headerlink" title="启动 inception"></a>启动 inception</h3><p>和MySQL是一样的，Inception可执行文件可以在编译目录下面通过find命令找到，编译目录就是在执行inception_build.sh脚本时指定的目录。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/debug/my</span>sql<span class="regexp">/bin/I</span>nception --defaults-<span class="keyword">file</span>=inc.cnf</span><br></pre></td></tr></table></figure>
<p>注意： 因为Inception支持OSC执行的功能，是通过调用 pt-online-schema-change 工具来做的，但如果Inception后台启动（&amp;）的话，可能会导致 pt-online-schema-change 在执行完成之后，长时间不返回，进而导致Inception卡死的问题，这个问题后面会解决，但现阶段请尽量不要使用后台启动的方式，或者可以使用 <code>nohup Inception 启动命令 &amp;</code> 的方式来启动。</p>
<h3 id="u5B89_u88C5_inception_web__u7AEF"><a href="#u5B89_u88C5_inception_web__u7AEF" class="headerlink" title="安装 inception_web 端"></a>安装 inception_web 端</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/dbalihui/inception_web.git</span><br><span class="line">pip <span class="keyword">install</span> flask_wtf</span><br><span class="line">pip <span class="keyword">install</span> flask-script</span><br><span class="line">pip <span class="keyword">install</span> flask-debugtoolbar</span><br><span class="line">pip <span class="keyword">install</span> MySQL-python</span><br><span class="line"><span class="comment">#在inception_web目录下运行</span></span><br><span class="line">./run.py runserver --host <span class="number">0.0</span>.<span class="number">0.0</span></span><br></pre></td></tr></table></figure>
<p>因为这个 web 界面的工具只是一个测试的 Demo 程序，很多深入的功能还需要自己开发。</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>Inception是集审核、执行、回滚于一体的一个自动化运维系统，它是根据MySQL代码修改过来的，用它可以很明确的，详细的，准确的审核MySQL的SQL语句，它的工作模式和MySQL完全相同，可以直接使用MySQL客户端来连接，Inception是一款自动化运维的利器，有别与现在各个公司使用的方式，使用Inception，将会给DBA带来最大的便利性，将DBA从繁冗的工作中解放出来，做一些更多的自动化工作，或者从架构方面研究如何更大程度的保证数据库的高可用等等。</p>]]>
    
    </summary>
    
      <category term="inception" scheme="http://blog.tanchao.org/tags/inception/"/>
    
      <category term="mysql" scheme="http://blog.tanchao.org/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[统一数据库表命名方式]]></title>
    <link href="http://blog.tanchao.org/2015/12/22/mysql-name/"/>
    <id>http://blog.tanchao.org/2015/12/22/mysql-name/</id>
    <published>2015-12-22T05:52:50.000Z</published>
    <updated>2016-01-21T06:58:43.000Z</updated>
    <content type="html"><![CDATA[<p>所有数据库名以 <code>dbname_</code> 打头，库名、表名必须使用下划线分割开，全部用小写字母，表名以库名的首字母缩写作为前缀，如<code>dbname_db</code>库下所有的表都以 <code>tbn</code> 表前缀，以保证该表的全局唯一性。</p>
<a id="more"></a>
<blockquote>
<p>数据库:<code>dbname_db</code><br>数据表:<code>tbn_info</code></p>
</blockquote>
<h3 id="u6267_u884C_SQL__u524D_u786E_u8BA4_u5F71_u54CD_u7684_u6570_u636E_u91CF_u5927_u5C0F"><a href="#u6267_u884C_SQL__u524D_u786E_u8BA4_u5F71_u54CD_u7684_u6570_u636E_u91CF_u5927_u5C0F" class="headerlink" title="执行 SQL 前确认影响的数据量大小"></a>执行 SQL 前确认影响的数据量大小</h3><blockquote>
<p><code>update</code> <code>delete</code> <code>alter</code> 之前先确认会影响的数据量大小</p>
</blockquote>
<h3 id="u6267_u884C_SQL__u65F6_u91C7_u7528use__u5BF9_u5E94_u7684_u6570_u636E_u5E93"><a href="#u6267_u884C_SQL__u65F6_u91C7_u7528use__u5BF9_u5E94_u7684_u6570_u636E_u5E93" class="headerlink" title="执行 SQL 时采用<code>use</code> 对应的数据库"></a>执行 SQL 时采用<code>use</code> 对应的数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">use</span> dbname_db;</span>          </span><br><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`tbn_info`</span> </span><br><span class="line"><span class="keyword">ADD</span> <span class="string">`allot_time`</span> <span class="built_in">INT</span>( <span class="number">11</span> ) <span class="keyword">UNSIGNED</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'分配时间'</span> , <span class="keyword">ADD</span> <span class="keyword">INDEX</span> ( <span class="string">`allot_time`</span> );</span></span><br></pre></td></tr></table></figure>
<h3 id="u6267_u884C_SQL__u65F6_u5728SQL_u8BED_u53E5_u4E2D_u6307_u5B9A_u7684_u6570_u636E_u5E93_uFF08_u6781_u7AEF_u60C5_u51B5_u4E0B_u4F1A_u5F71_u54CD_u540C_u6B65_uFF09"><a href="#u6267_u884C_SQL__u65F6_u5728SQL_u8BED_u53E5_u4E2D_u6307_u5B9A_u7684_u6570_u636E_u5E93_uFF08_u6781_u7AEF_u60C5_u51B5_u4E0B_u4F1A_u5F71_u54CD_u540C_u6B65_uFF09" class="headerlink" title="执行 SQL 时在SQL语句中指定的数据库（极端情况下会影响同步）"></a>执行 SQL 时在SQL语句中指定的数据库（极端情况下会影响同步）</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> dbname_db.<span class="string">`tbn_info`</span> </span><br><span class="line"><span class="keyword">ADD</span> <span class="string">`allot_time`</span> <span class="built_in">INT</span>( <span class="number">11</span> ) <span class="keyword">UNSIGNED</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'分配时间'</span> , <span class="keyword">ADD</span> <span class="keyword">INDEX</span> ( <span class="string">`allot_time`</span> );</span></span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<p>所有数据库名以 <code>dbname_</code> 打头，库名、表名必须使用下划线分割开，全部用小写字母，表名以库名的首字母缩写作为前缀，如<code>dbname_db</code>库下所有的表都以 <code>tbn</code> 表前缀，以保证该表的全局唯一性。</p>]]>
    
    </summary>
    
      <category term="mysql" scheme="http://blog.tanchao.org/tags/mysql/"/>
    
      <category term="test" scheme="http://blog.tanchao.org/tags/test/"/>
    
      <category term="MySQL" scheme="http://blog.tanchao.org/categories/MySQL/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[安装 mha 实现 MySQL 主库高可用]]></title>
    <link href="http://blog.tanchao.org/2015/12/17/install-mha/"/>
    <id>http://blog.tanchao.org/2015/12/17/install-mha/</id>
    <published>2015-12-17T03:40:51.000Z</published>
    <updated>2016-03-23T10:28:11.000Z</updated>
    <content type="html"><![CDATA[<p>MHA是一位日本MySQL大牛用Perl写的一套MySQL故障切换方案，来保证数据库系统的高可用.在宕机的时间内（通常10—30秒内），完成故障切换，部署MHA，可避免主从一致性问题，节约购买新服务器的费用，不影响服务器性能，易安装，不改变现有部署。还支持在线切换，从当前运行master切换到一个新的master上面，只需要很短的时间（0.5-2秒内），此时仅仅阻塞写操作，并不影响读操作，便于主机硬件维护。在有高可用，数据一致性要求的系统上，MHA 提供了有用的功能，几乎无间断的满足维护需要。</p>
<a id="more"></a>
<h3 id="u6D4B_u8BD5_u73AF_u5883"><a href="#u6D4B_u8BD5_u73AF_u5883" class="headerlink" title="测试环境"></a>测试环境</h3><p>操作系统: CentOS 6.x 64位</p>
<table>
<thead>
<tr>
<th style="text-align:center">主机名</th>
<th style="text-align:center">IP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">master</td>
<td style="text-align:center">192.168.1.100</td>
</tr>
<tr>
<td style="text-align:center">slave1</td>
<td style="text-align:center">192.168.1.101</td>
</tr>
<tr>
<td style="text-align:center">slave2</td>
<td style="text-align:center">192.168.1.102</td>
</tr>
<tr>
<td style="text-align:center">MHA manager</td>
<td style="text-align:center">192.168.1.103</td>
</tr>
</tbody>
</table>
<h3 id="u51C6_u5907"><a href="#u51C6_u5907" class="headerlink" title="准备"></a>准备</h3><p>作为前提条件，应先配置MySQL复制，并设置SSH公钥免密码登录。下面以CentOS为例来说明，最好先安装EPEL，不然YUM可能找不到某些软件包。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># ssh-keygen -t rsa  </span></span><br><span class="line"><span class="preprocessor"># ssh-copy-id -i /root/.ssh/id_rsa.pub root@ <span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span></span></span><br><span class="line"><span class="preprocessor"># ssh-copy-id -i /root/.ssh/id_rsa.pub root@ <span class="number">192.168</span><span class="number">.1</span><span class="number">.101</span></span></span><br><span class="line"><span class="preprocessor"># ssh-copy-id -i /root/.ssh/id_rsa.pub root@ <span class="number">192.168</span><span class="number">.1</span><span class="number">.102</span></span></span><br><span class="line"><span class="preprocessor"># ssh-copy-id -i /root/.ssh/id_rsa.pub root@ <span class="number">192.168</span><span class="number">.1</span><span class="number">.103</span></span></span><br></pre></td></tr></table></figure>
<p>添加管理账号</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> *.* <span class="keyword">TO</span> mha@<span class="string">'192.168.1.%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'test'</span>;</span>  </span><br><span class="line"><span class="operator"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span></span><br></pre></td></tr></table></figure>
<p>下载 MHA 套件：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">mha4mysql-node-0</span><span class="class">.56-0</span><span class="class">.el6</span><span class="class">.noarch</span><span class="class">.rpm</span></span><br><span class="line"><span class="tag">mha4mysql-manager-0</span><span class="class">.56-0</span><span class="class">.el6</span><span class="class">.noarch</span><span class="class">.rpm</span></span><br></pre></td></tr></table></figure>
<p><a href="https://code.google.com/p/mysql-master-ha/wiki/Downloads?tm=2" target="_blank" rel="external">https://code.google.com/p/mysql-master-ha/wiki/Downloads?tm=2</a></p>
<h3 id="u5B89_u88C5"><a href="#u5B89_u88C5" class="headerlink" title="安装"></a>安装</h3><p>安装Manager：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">yum</span> <span class="tag">localinstall</span> <span class="tag">-y</span> <span class="tag">mha4mysql-node-0</span><span class="class">.56-0</span><span class="class">.el6</span><span class="class">.noarch</span><span class="class">.rpm</span></span><br><span class="line"><span class="tag">yum</span> <span class="tag">localinstall</span> <span class="tag">-y</span> <span class="tag">mha4mysql-manager-0</span><span class="class">.56-0</span><span class="class">.el6</span><span class="class">.noarch</span><span class="class">.rpm</span></span><br></pre></td></tr></table></figure>
<p>安装Node：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">yum</span> <span class="tag">localinstall</span> <span class="tag">-y</span> <span class="tag">mha4mysql-node-0</span><span class="class">.56-0</span><span class="class">.el6</span><span class="class">.noarch</span><span class="class">.rpm</span></span><br><span class="line"><span class="tag">yum</span> <span class="tag">localinstall</span> <span class="tag">-y</span> <span class="tag">mha4mysql-manager-0</span><span class="class">.56-0</span><span class="class">.el6</span><span class="class">.noarch</span><span class="class">.rpm</span></span><br></pre></td></tr></table></figure>
<h3 id="u914D_u7F6E"><a href="#u914D_u7F6E" class="headerlink" title="配置"></a>配置</h3><p>全局配置文件 (/etc/masterha_default.cnf)</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[server default]</span></span><br><span class="line"><span class="setting">user=<span class="value">root</span></span></span><br><span class="line"><span class="setting">password=<span class="value">rootpass</span></span></span><br><span class="line"><span class="setting">ssh_user=<span class="value">root</span></span></span><br><span class="line"><span class="setting">master_binlog_dir= <span class="value">/var/lib/mysql</span></span></span><br><span class="line"><span class="setting">remote_workdir=<span class="value">/data/log/masterha</span></span></span><br><span class="line"><span class="setting">secondary_check_script= <span class="value">masterha_secondary_check -s remote_host1 -s remote_host2</span></span></span><br><span class="line"><span class="setting">ping_interval=<span class="value"><span class="number">3</span></span></span></span><br><span class="line"><span class="setting">master_ip_failover_script=<span class="value">/script/masterha/master_ip_failover</span></span></span><br><span class="line"><span class="setting">shutdown_script= <span class="value">/script/masterha/power_manager</span></span></span><br><span class="line"><span class="setting">report_script= <span class="value">/script/masterha/send_master_failover_mail</span></span></span><br></pre></td></tr></table></figure>
<p><strong>Application configuration file should be written separately. The below example is configuraing app1 (host1-4) and app2 (host11-14).</strong></p>
<p>应用配置文件 (/etc/app1.cnf)</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[server default]</span></span><br><span class="line"><span class="setting">manager_workdir=<span class="value">/var/log/masterha/app1</span></span></span><br><span class="line"><span class="setting">manager_log=<span class="value">/var/log/masterha/app1/app1.log</span></span></span><br><span class="line"><span class="title">  </span><br><span class="line">[server1]</span></span><br><span class="line"><span class="setting">hostname=<span class="value">master</span></span></span><br><span class="line"><span class="title">  </span><br><span class="line">[server2]</span></span><br><span class="line"><span class="setting">hostname=<span class="value">slave1</span></span></span><br><span class="line"><span class="setting">candidate_master=<span class="value"><span class="number">1</span></span></span></span><br><span class="line"><span class="title">  </span><br><span class="line">[server3]</span></span><br><span class="line"><span class="setting">hostname=<span class="value">slave2</span></span></span><br><span class="line"><span class="setting">no_master=<span class="value"><span class="number">1</span></span></span></span><br></pre></td></tr></table></figure>
<p>更多配置参考官方文档:</p>
<p><a href="https://code.google.com/p/mysql-master-ha/wiki/Configuration" target="_blank" rel="external">MHA配置文件</a><br><a href="https://code.google.com/p/mysql-master-ha/wiki/Parameters" target="_blank" rel="external">MHA支持的参数</a></p>
<h3 id="u68C0_u67E5"><a href="#u68C0_u67E5" class="headerlink" title="检查"></a>检查</h3><p>检查SSH公钥免密码登录：</p>
<p><code>masterha_check_ssh --conf=/etc/app1.cnf</code></p>
<p>检查MySQL复制：  </p>
<p><code>masterha_check_repl --conf=/etc/app1.cnf</code></p>
<h3 id="u5B9E_u6218"><a href="#u5B9E_u6218" class="headerlink" title="实战"></a>实战</h3><p>首先启动 MHA 进程：</p>
<p><code>nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</code></p>
<p>注：视配置情况而定，可能会提示 <code>read_only</code>，<code>relay_log_purge</code> 等警告信息。</p>
<p>然后检查 MHA 状态：</p>
<p><code>masterha_check_status --conf=/etc/mha/app1.cnf</code></p>
<p>注：如果正常，会显示『PING_OK』，否则会显示『NOT_RUNNING』。</p>
<p>关闭监控：</p>
<p><code>masterha_stop --conf=/etc/mha/app1.cnf</code></p>
<p>管理端常用命令:</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">masterh<span class="built_in">a_check</span>_ssh       检查MHA的SSH配置状况  </span><br><span class="line">masterh<span class="built_in">a_check</span>_repl      检查MySQL复制状况  </span><br><span class="line">masterh<span class="built_in">a_manger</span>          启动MHA  </span><br><span class="line">masterh<span class="built_in">a_check</span>_status    检测当前MHA运行状态  </span><br><span class="line">masterh<span class="built_in">a_master</span>_monitor  检测master是否宕机  </span><br><span class="line">masterh<span class="built_in">a_master</span>_switch   控制故障转移（自动或者手动）  </span><br><span class="line">masterh<span class="built_in">a_conf</span>_host       添加或删除配置的server信息</span><br></pre></td></tr></table></figure>
<p>在线切换主从：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">masterha_master_switch</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">conf=/etc/mha/app1</span><span class="string">.</span><span class="comment">cnf</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">master_state=alive</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">new_master_host=192</span><span class="string">.</span><span class="comment">168</span><span class="string">.</span><span class="comment">10</span><span class="string">.</span><span class="comment">101</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">new_master_port=3306</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">orig_master_is_new_slave</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">running_updates_limit=10000</span></span><br></pre></td></tr></table></figure>
<p>内容基于:<br><a href="http://huoding.com/2011/12/18/139" target="_blank" rel="external">火丁笔记</a><br><a href="http://blog.51yip.com/mysql/1722.html" target="_blank" rel="external">海底苍鹰(tank)博客</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>MHA是一位日本MySQL大牛用Perl写的一套MySQL故障切换方案，来保证数据库系统的高可用.在宕机的时间内（通常10—30秒内），完成故障切换，部署MHA，可避免主从一致性问题，节约购买新服务器的费用，不影响服务器性能，易安装，不改变现有部署。还支持在线切换，从当前运行master切换到一个新的master上面，只需要很短的时间（0.5-2秒内），此时仅仅阻塞写操作，并不影响读操作，便于主机硬件维护。在有高可用，数据一致性要求的系统上，MHA 提供了有用的功能，几乎无间断的满足维护需要。</p>]]>
    
    </summary>
    
      <category term="mha" scheme="http://blog.tanchao.org/tags/mha/"/>
    
      <category term="mysql" scheme="http://blog.tanchao.org/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[PXC（Percona XtraDB Cluster）集群安装]]></title>
    <link href="http://blog.tanchao.org/2015/12/15/install-pxc/"/>
    <id>http://blog.tanchao.org/2015/12/15/install-pxc/</id>
    <published>2015-12-15T05:56:39.000Z</published>
    <updated>2016-03-29T09:29:50.000Z</updated>
    <content type="html"><![CDATA[<p>Percona XtraDB Cluster 是 MySQL 高可用性和可扩展性的解决方案。Percona Server 是MySQL的改进版本，使用 XtraDB 存储引擎，在功能和性能上较 MySQL 有着很显著的提升，如提升了在高负载情况下的 InnoDB 的性能，Percona XtraDB Cluster 完全兼容 MySQL 和 Percona Server。 </p>
<a id="more"></a>
<h3 id="Percona_XtraDB_Cluster__u63D0_u4F9B_u7684_u7279_u6027_u6709_uFF1A"><a href="#Percona_XtraDB_Cluster__u63D0_u4F9B_u7684_u7279_u6027_u6709_uFF1A" class="headerlink" title="Percona XtraDB Cluster 提供的特性有："></a>Percona XtraDB Cluster 提供的特性有：</h3><ul>
<li>同步复制，事务要么在所有节点提交或不提交。</li>
<li>多主复制，可以在任意节点进行写操作。</li>
<li>在从服务器上并行应用事件，真正意义上的并行复制。</li>
<li>节点自动配置。</li>
<li>数据一致性，不再是异步复制。</li>
<li>每个节点都包含完整的数据副本。</li>
<li>无需集中管理。可以在任何时间点失去任何节点，但是集群将照常工作。</li>
<li>应用程序的兼容性：无需更改应用程序。</li>
</ul>
<h3 id="PXC__u540C_u65F6_u4E5F_u6709_u7F3A_u70B9_u5982_u4E0B_uFF1A"><a href="#PXC__u540C_u65F6_u4E5F_u6709_u7F3A_u70B9_u5982_u4E0B_uFF1A" class="headerlink" title="PXC 同时也有缺点如下："></a>PXC 同时也有缺点如下：</h3><ul>
<li>加入新节点，开销大。需要复制完整的数据。</li>
<li>不能有效的解决写缩放问题，所有的写操作都将发生在所有节点上。</li>
<li>有多少个节点就有多少重复的数据。</li>
</ul>
<h3 id="PXC_u5B89_u88C5_u73AF_u5883"><a href="#PXC_u5B89_u88C5_u73AF_u5883" class="headerlink" title="PXC安装环境"></a>PXC安装环境</h3><blockquote>
<p>操作系统: CentOS 6.x 64位 最小化安装</p>
</blockquote>
<p>集群最小化要求3个 Node</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th style="text-align:center">Node Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.122.11</td>
<td>db1.test.com</td>
<td style="text-align:center">db_01</td>
</tr>
<tr>
<td>192.168.122.12</td>
<td>db2.test.com</td>
<td style="text-align:center">db_02</td>
</tr>
<tr>
<td>192.168.122.13</td>
<td>db3.test.com</td>
<td style="text-align:center">db_03</td>
</tr>
</tbody>
</table>
<p>在 DNS 里解析主机名，或者在 host 文件里加入下面的内容</p>
<blockquote>
<p>192.168.122.11    db1.test.com<br>192.168.122.12    db2.test.com<br>192.168.122.13    db3.test.com</p>
</blockquote>
<p>开放 <code>iptables</code> 端口限制</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#注意只暴露给内网对应的设备</span><br><span class="line">iptables -I INPUT -<span class="tag">p</span> tcp --dport <span class="number">3306</span> -j ACCEPT</span><br><span class="line">iptables -I INPUT -<span class="tag">p</span> tcp --dport <span class="number">4444</span> -j ACCEPT</span><br><span class="line">iptables -I INPUT -<span class="tag">p</span> tcp --dport <span class="number">4567</span> -j ACCEPT</span><br><span class="line"></span><br><span class="line">#记得保存</span><br><span class="line">/etc/init.d/iptables save</span><br></pre></td></tr></table></figure>
<p>关闭 <code>selinux</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce <span class="number">0</span></span><br><span class="line">sed -<span class="tag">i</span> <span class="string">'s/SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config</span><br></pre></td></tr></table></figure>
<h3 id="PXC_u5B89_u88C5_u8FC7_u7A0B"><a href="#PXC_u5B89_u88C5_u8FC7_u7A0B" class="headerlink" title="PXC安装过程"></a>PXC安装过程</h3><p>在每个Node上执行下面的操作</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#安装 epel 源</span></span><br><span class="line">yum install http:<span class="comment">//mirrors.yun-idc.com/epel/6/i386/epel-release-6-8.noarch.rpm</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#安装 percona 官方源</span></span><br><span class="line">yum install http:<span class="comment">//www.percona.com/downloads/percona-release/redhat/0.1-3/percona-release-0.1-3.noarch.rpm</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#这里是安装的<span class="number">5.6</span>，如果要安装<span class="number">5.5</span>把下面的<span class="number">56</span>换成<span class="number">55</span>即可</span></span><br><span class="line">yum install Percona-XtraDB-Cluster-server-<span class="number">56</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#mysql 加入自启动</span></span><br><span class="line">chkconfig --level <span class="number">3</span> mysql on</span><br></pre></td></tr></table></figure>
<p>启动 <code>db_01</code> 的数据库并创建 sst 用户</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/mysql <span class="operator"><span class="keyword">start</span></span><br><span class="line"></span><br><span class="line">#创建 sst 用户，不能用下面的弱密码</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">'sstuser'</span>@<span class="string">'localhost'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'password'</span>;</span>    <span class="operator"><span class="keyword">GRANT</span> RELOAD, <span class="keyword">LOCK</span> <span class="keyword">TABLES</span>, <span class="keyword">REPLICATION</span> <span class="keyword">CLIENT</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'sstuser'</span>@<span class="string">'localhost'</span>;</span>          </span><br><span class="line"><span class="operator"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span></span><br></pre></td></tr></table></figure>
<p>在 <code>db_01</code> 的 my.cnf 里加入以下配置</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server-id = 1911</span><br><span class="line"><span class="constant">wsrep_provider</span>=/usr/lib64/libgalera_smm.so</span><br><span class="line"><span class="constant">wsrep_cluster_address</span>="gcomm://"</span><br><span class="line"><span class="constant">wsrep_sst_auth</span>="sstuser:password"</span><br><span class="line"><span class="constant">wsrep_provider_options</span>="gcache.size=2G"</span><br><span class="line"><span class="constant">wsrep_cluster_name</span>=Percona</span><br><span class="line"><span class="constant">wsrep_sst_method</span>=xtrabackup-v2</span><br><span class="line"><span class="constant">wsrep_node_name</span>=db_01</span><br><span class="line"><span class="constant">wsrep_slave_threads</span>=4</span><br><span class="line"><span class="constant">binlog_format</span>=ROW</span><br><span class="line">log_slave_updates</span><br><span class="line"><span class="constant">innodb_locks_unsafe_for_binlog</span>=1</span><br><span class="line"><span class="constant">innodb_autoinc_lock_mode</span>=2</span><br><span class="line"><span class="constant">default_storage_engine</span>=InnoDB</span><br></pre></td></tr></table></figure>
<p>重启 <code>db_01</code> 数据库</p>
<p><code>/etc/init.d/mysql restart</code></p>
<p>在其它 Node 的 my.cnf 加下面的配置</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#注意Server-id 应该每个机器不一样</span></span><br><span class="line">server-id = <span class="number">1911</span></span><br><span class="line">wsrep_provider=/usr/lib64/libgalera_smm.so</span><br><span class="line"><span class="preprocessor">#这里指定到db_01的主机名 db1.test.com</span></span><br><span class="line">wsrep_cluster_address=<span class="string">"gcomm://db1.test.com"</span></span><br><span class="line">wsrep_sst_auth=<span class="string">"sstuser:password"</span></span><br><span class="line">wsrep_provider_options=<span class="string">"gcache.size=2G"</span></span><br><span class="line">wsrep_cluster_name=Percona</span><br><span class="line"><span class="preprocessor">#指定SST方式，支持rsync(最快，需要锁表)，mysqldump 和 xtrabackup</span></span><br><span class="line"><span class="preprocessor">#从 <span class="number">5.5</span><span class="number">.33</span>-<span class="number">23.7</span><span class="number">.6</span> 起支持 xtrabackup-v2</span></span><br><span class="line"><span class="preprocessor">#<span class="number">5.6</span> 默认是 xtrabackup-v2 ,可以不配置这上选项，但不能配置为 xtrabackup</span></span><br><span class="line">wsrep_sst_method=xtrabackup-v2</span><br><span class="line"><span class="preprocessor">#节点的名称，每个机器要区别开来</span></span><br><span class="line">wsrep_node_name=db_01</span><br><span class="line">wsrep_slave_threads=<span class="number">4</span></span><br><span class="line">binlog_format=ROW</span><br><span class="line">log_slave_updates</span><br><span class="line">innodb_locks_unsafe_for_binlog=<span class="number">1</span></span><br><span class="line">innodb_autoinc_lock_mode=<span class="number">2</span></span><br><span class="line">default_storage_engine=InnoDB</span><br></pre></td></tr></table></figure>
<p>启动其它节点的数据库</p>
<p><code>/etc/init.d/mysql start</code></p>
<h3 id="u6545_u969C_u96C6"><a href="#u6545_u969C_u96C6" class="headerlink" title="故障集"></a>故障集</h3><p>日志显示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">32</span> <span class="number">2294</span> [Note] <span class="string">WSREP:</span> (dbc8e586, <span class="string">'tcp://0.0.0.0:4567'</span>) listening at <span class="string">tcp:</span><span class="comment">//0.0.0.0:4567</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">32</span> <span class="number">2294</span> [Note] <span class="string">WSREP:</span> (dbc8e586, <span class="string">'tcp://0.0.0.0:4567'</span>) <span class="string">multicast:</span> , <span class="string">ttl:</span> <span class="number">1</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">32</span> <span class="number">2294</span> [Note] <span class="string">WSREP:</span> EVS version <span class="number">0</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">32</span> <span class="number">2294</span> [Note] <span class="string">WSREP:</span> <span class="string">gcomm:</span> connecting to group <span class="string">'Percona'</span>, peer <span class="string">'db1.test.com:'</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">32</span> <span class="number">2294</span> [ERROR] <span class="string">WSREP:</span> Permission denied</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">32</span> <span class="number">2294</span> [ERROR] <span class="string">WSREP:</span> failed to open gcomm backend <span class="string">connection:</span> <span class="number">13</span>: error <span class="keyword">while</span> trying to listen <span class="string">'tcp://0.0.0.0:4567?socket.non_blocking=1'</span>, asio error <span class="string">'Permission denied'</span>: <span class="number">13</span> (Permission denied) at gcomm<span class="regexp">/src/</span>asio_tcp.<span class="string">cpp:</span>listen():<span class="number">783</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">32</span> <span class="number">2294</span> [ERROR] <span class="string">WSREP:</span> gcs<span class="regexp">/src/</span>gcs_core.<span class="string">cpp:</span>gcs_core_open():<span class="number">206</span>: Failed to open backend <span class="string">connection:</span> -<span class="number">13</span> (Permission denied)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">32</span> <span class="number">2294</span> [ERROR] <span class="string">WSREP:</span> gcs<span class="regexp">/src/</span>gcs.<span class="string">cpp:</span>gcs_open():<span class="number">1379</span>: Failed to open channel <span class="string">'Percona'</span> at <span class="string">'gcomm://db1.test.com'</span>: -<span class="number">13</span> (Permission denied)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">32</span> <span class="number">2294</span> [ERROR] <span class="string">WSREP:</span> gcs connect <span class="string">failed:</span> Permission denied</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">32</span> <span class="number">2294</span> [ERROR] <span class="string">WSREP:</span> <span class="string">wsrep:</span>:connect(<span class="string">gcomm:</span><span class="comment">//db1.test.com) failed: 7</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">32</span> <span class="number">2294</span> [ERROR] Aborting</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">53</span>:<span class="number">32</span> <span class="number">2294</span> [Note] <span class="string">WSREP:</span> Service disconnected.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>解决方法：<br>关闭 <code>selinux</code></p>
</blockquote>
<p>日志显示：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">33</span> <span class="number">9716</span> [Note] WSREP: REPL Protocols: <span class="number">7</span> (<span class="number">3</span>, <span class="number">2</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">33</span> <span class="number">9716</span> [Note] WSREP: Service thread queue flushed.</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">33</span> <span class="number">9716</span> [Note] WSREP: Assign initial position <span class="keyword">for</span> certification: <span class="number">4</span>, protocol version: <span class="number">3</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">33</span> <span class="number">9716</span> [Note] WSREP: Service thread queue flushed.</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">33</span> <span class="number">9716</span> [Warning] WSREP: Failed <span class="keyword">to</span> prepare <span class="keyword">for</span> incremental <span class="keyword">state</span> transfer: Local <span class="keyword">state</span> UUID (<span class="number">00000000</span>-<span class="number">0000</span>-<span class="number">0000</span>-<span class="number">0000</span>-<span class="number">000000000000</span>) does not <span class="built_in">match</span> <span class="keyword">group</span> <span class="keyword">state</span> UUID (<span class="number">0055</span>f119-<span class="number">8434</span>-<span class="number">11</span>e5-b4c5-<span class="number">52</span>dd3f2636cd): <span class="number">1</span> (Operation not permitted) at galera/src/replicator_str.cpp:prepare_for_IST():<span class="number">482</span>. IST will be unavailable.</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">33</span> <span class="number">9716</span> [Note] WSREP: Member <span class="number">1.0</span> (db_02) requested <span class="keyword">state</span> transfer <span class="keyword">from</span> '*<span class="literal">any</span>*'. Selected <span class="number">0.0</span> (db_01)(SYNCED) as donor.</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">33</span> <span class="number">9716</span> [Note] WSREP: Shifting PRIMARY -&gt; JOINER (TO: <span class="number">4</span>)</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">33</span> <span class="number">9716</span> [Note] WSREP: Requesting <span class="keyword">state</span> transfer: success, donor: <span class="number">0</span></span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">35</span> <span class="number">9716</span> [Note] WSREP: <span class="number">0.0</span> (db_01): State transfer <span class="keyword">to</span> <span class="number">1.0</span> (db_02) complete.</span><br><span class="line"><span class="number">2015</span>-<span class="number">11</span>-<span class="number">06</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">35</span> <span class="number">9716</span> [Note] WSREP: Member <span class="number">0.0</span> (db_01) synced with <span class="keyword">group</span>.</span><br><span class="line">WSREP_SST: [ERROR] xtrabackup process ended without creating '/var/lib/mysql//xtrabackup_galera_info' (<span class="number">20151106</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">35.663</span>)</span><br><span class="line">WSREP_SST: [INFO] Contents of datadir (<span class="number">20151106</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">35.664</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>解决方法：<br>将my.cnf 里的配置 wsrep_sst_method=xtrabackup-v2</p>
</blockquote>
<h3 id="PXC_u5C40_u9650_u6027"><a href="#PXC_u5C40_u9650_u6027" class="headerlink" title="PXC局限性"></a>PXC局限性</h3><ol>
<li>目前的复制仅仅支持InnoDB存储引擎。任何写入其他引擎的表，包括mysql.*表将不会复制。但是DDL语句会被复制的，因此创建用户将会被复制，但是insert into mysql.user…将不会被复制的。</li>
<li>DELETE操作不支持没有主键的表。没有主键的表在不同的节点顺序将不同，如果执行SELECT…LIMIT… 将出现不同的结果集。</li>
<li>在多主环境下LOCK/UNLOCK TABLES不支持。以及锁函数GET_LOCK(), RELEASE_LOCK()…</li>
<li>查询日志不能保存在表中。如果开启查询日志，只能保存到文件中。</li>
<li>允许最大的事务大小由wsrep_max_ws_rows和wsrep_max_ws_size定义。任何大型操作将被拒绝。如大型的LOAD DATA操作。</li>
<li>由于集群是乐观的并发控制，事务commit可能在该阶段中止。如果有两个事务向在集群中不同的节点向同一行写入并提交，失败的节点将中止。对于集群级别的中止，集群返回死锁错误代码(Error: 1213 SQLSTATE: 40001 (ER_LOCK_DEADLOCK)).</li>
<li>XA事务不支持，由于在提交上可能回滚。</li>
<li>整个集群的写入吞吐量是由最弱的节点限制，如果有一个节点变得缓慢，那么整个集群将是缓慢的。为了稳定的高性能要求，所有的节点应使用统一的硬件。</li>
<li>集群节点建议最少3个。</li>
<li>如果DDL语句有问题将破坏集群。</li>
</ol>
]]></content>
    <summary type="html">
    <![CDATA[<p>Percona XtraDB Cluster 是 MySQL 高可用性和可扩展性的解决方案。Percona Server 是MySQL的改进版本，使用 XtraDB 存储引擎，在功能和性能上较 MySQL 有着很显著的提升，如提升了在高负载情况下的 InnoDB 的性能，Percona XtraDB Cluster 完全兼容 MySQL 和 Percona Server。 </p>]]>
    
    </summary>
    
      <category term="mysql" scheme="http://blog.tanchao.org/tags/mysql/"/>
    
      <category term="percona" scheme="http://blog.tanchao.org/tags/percona/"/>
    
      <category term="pxc" scheme="http://blog.tanchao.org/tags/pxc/"/>
    
      <category term="MySQL" scheme="http://blog.tanchao.org/categories/MySQL/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Ubuntu 12.04 安装 OpenERP 7.0]]></title>
    <link href="http://blog.tanchao.org/2014/06/16/ubuntu-12-04-install-openerp-7-0/"/>
    <id>http://blog.tanchao.org/2014/06/16/ubuntu-12-04-install-openerp-7-0/</id>
    <published>2014-06-16T06:30:01.000Z</published>
    <updated>2015-12-22T06:36:33.000Z</updated>
    <content type="html"><![CDATA[<p>OpenERP是开源的ERP系统，功能丰富，通用性高，扩展性强，它的界面非常漂亮，安装也很简单。OpenERP官方有提供 Ubuntu 软件源，建议系统选择 Ubuntu，这样可以节省不少的时间和工作量。似乎 OpenERP 的开发者是在 Ubuntu 平台下工作的，对 Ubuntu 的支持都好过其它的发行版本，资料也是基于 Ubuntu 来编写的。</p>
<a id="more"></a>
<p>1.添加 OpenERP 官方的 Ubuntu 源并刷新列表</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="keyword">echo</span> <span class="string">"deb http://nightly.openerp.com/7.0/nightly/deb/ ./"</span> &gt;&gt; /etc/apt/sources.<span class="keyword">list</span></span><br><span class="line">sudo apt-<span class="built_in">get</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure>
<p>2.安装 OpenERP 用使用的 Postgresql 数据库</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="keyword">get</span> install postgresql</span><br></pre></td></tr></table></figure>
<p>3.设置 Postgresql 用户信息</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo su postgres</span><br><span class="line"></span><br><span class="line">   createuser openerp</span><br><span class="line">        Shall the new <span class="keyword">role</span> <span class="title">be</span> a superuser? (y/n) y</span><br><span class="line">    psql template1</span><br><span class="line"></span><br><span class="line">     alter <span class="keyword">role</span> <span class="title">openerp</span> with password 'postgres';</span><br></pre></td></tr></table></figure>
<p>4.安装 OpenERP 需要的 Python 依赖</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install <span class="keyword">python</span>-dateutil <span class="keyword">python</span>-feedparser <span class="keyword">python</span>-gdata <span class="keyword">python</span>-ldap <span class="keyword">python</span>-libxslt1 <span class="keyword">python</span>-lxml <span class="keyword">python</span>-mako <span class="keyword">python</span>-openid <span class="keyword">python</span>-psycopg2 <span class="keyword">python</span>-pybabel <span class="keyword">python</span>-pychart <span class="keyword">python</span>-pydot <span class="keyword">python</span>-pyparsing <span class="keyword">python</span>-reportlab <span class="keyword">python</span>-simplejson <span class="keyword">python</span>-tz <span class="keyword">python</span>-vatnumber <span class="keyword">python</span>-vobject <span class="keyword">python</span>-webdav <span class="keyword">python</span>-werkzeug <span class="keyword">python</span>-xlwt <span class="keyword">python</span>-yaml <span class="keyword">python</span>-zsi</span><br></pre></td></tr></table></figure>
<p>5.安装 OpenERP</p>
<p>查看源代码打印帮助</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="keyword">get</span> install openerp</span><br></pre></td></tr></table></figure>
<p>6.初始化设置</p>
<p>启动 OpenERP:</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/openerp <span class="literal">start</span></span><br></pre></td></tr></table></figure>
<p>这个时候就可以通过浏览器打 <code>http://hostname:8069</code> ，打开之前请确保 iptalbes 防火墙已经开放此端口。</p>
<p>按 WEB 界面的提示设置便可以轻松完成安装。</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>OpenERP是开源的ERP系统，功能丰富，通用性高，扩展性强，它的界面非常漂亮，安装也很简单。OpenERP官方有提供 Ubuntu 软件源，建议系统选择 Ubuntu，这样可以节省不少的时间和工作量。似乎 OpenERP 的开发者是在 Ubuntu 平台下工作的，对 Ubuntu 的支持都好过其它的发行版本，资料也是基于 Ubuntu 来编写的。</p>]]>
    
    </summary>
    
      <category term="openerp" scheme="http://blog.tanchao.org/tags/openerp/"/>
    
      <category term="ubuntu" scheme="http://blog.tanchao.org/tags/ubuntu/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Cacti 监控平台迁移备忘]]></title>
    <link href="http://blog.tanchao.org/2011/10/12/cacti-migrate/"/>
    <id>http://blog.tanchao.org/2011/10/12/cacti-migrate/</id>
    <published>2011-10-12T08:38:00.000Z</published>
    <updated>2015-12-22T08:53:42.000Z</updated>
    <content type="html"><![CDATA[<p>公司用的 Cacti 监控平台已经有些时日了，一直运行很稳定，不过，昨天接到通知要迁移 Cacti 平台到别外的一台新服务器。以初以为直接把 Cacti 的 WEB 文件和数据库同步到新服务器就可以了，在实际操作的过程中发现并不是这样的。</p>
<a id="more"></a>
<p>首先配置好新服务器的LNMP环境，并将原来的 Cacti 的WEB文件和 mysql 同步到新的服务器。考虑到服务器的安全因素，我的环境配置脚本默认是把 PHP 的以下函数禁用的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">disable</span>_<span class="built_in">functions</span> = system,<span class="built_in">exec</span>,shell_<span class="built_in">exec</span>,passthru,popen,dl</span><br></pre></td></tr></table></figure>
<p>Cacti 在读取数据和画图的时候需要 exec() shell_exec() popen() 等函数，果然没有开启，可能会出现不能出图的情况。</p>
<p>如果新的服务器上的文件目录和之前的不一致，需要在引入 sql 之前编辑修改一下路径。不然有可能出现 Cacti 不能正常调用一些脚本的情况。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi cacti.sql</span><br><span class="line">:%s<span class="regexp">/\/</span>old\<span class="regexp">/cacti.tanchao.org/\/</span><span class="keyword">new</span>\<span class="regexp">/cacti.tanchao.org/</span>g</span><br></pre></td></tr></table></figure>
<p>用vi替换的时候注意一下“/”的转义。</p>
<p>检查一下 Cacti 中的 settings paths 的选项是否和新的服务器上的实际环境一致</p>
<p><img src="http://7xp8gg.com1.z0.glb.clouddn.com/cacti_setting_paths.jpg" alt=""></p>
<p>然后把被监控的服务器上的设置改一下，把IP改为新的服务器的</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> /etc/snmp/snmpd.<span class="keyword">conf</span></span><br><span class="line"></span><br><span class="line"># First, <span class="built_in">map</span> the community name <span class="string">"public"</span> into <span class="keyword">a</span> <span class="string">"security name"</span></span><br><span class="line"></span><br><span class="line">#       sec.name  <span class="keyword">source</span>          community</span><br><span class="line">com2sec notConfigUser  新的cacti监控服务器的IP  public</span><br><span class="line"></span><br><span class="line">/etc/init.<span class="keyword">d</span>/snmpd restart</span><br></pre></td></tr></table></figure>
<p>然后向 iptables 添加一条新的记录，让其允许和新的监控服务器通信</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -s 新的cacti监控服务器的IP -<span class="tag">p</span> udp --dport <span class="number">161</span> -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>最后不要忘记在 crontab 中加定期执行 poller.php</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crontab -e</span><br><span class="line"></span><br><span class="line"><span class="keyword">*</span>/5 <span class="keyword">*</span> <span class="keyword">*</span> <span class="keyword">*</span> <span class="keyword">*</span> php /new/cacti.tanchao.org/poller.php &gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>这个时候，新的 Cacti 监控就应该可以正常工作了。</p>
<p>如果你之前安装有监控 Nginx  的脚本，不要忘记让 perl 支持 LWP::UserAgent ，否则 Nginx 的监控部分会出不来图。</p>
<p>测试是否已经开启支持：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/new/</span>tanchao.org<span class="regexp">/get_nginx_clients_status.pl http:/</span><span class="regexp">/tanchao.org/</span>nginx_status</span><br></pre></td></tr></table></figure>
<p>如提示 no (LWP::UserAgent not found) 就说明了 perl 的确是缺少该组件</p>
<p>两种方法安装支持，第一种编译花的时间比较长，建议使用第二种：</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#方法一：</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#perl -MCPAN -e shell 一直回车，知道出现cpan&gt;  提示符开始。</span></span><br><span class="line">cpan&gt; install LWP::UserAgent</span><br><span class="line">……………………………………</span><br><span class="line">……………………………………</span><br><span class="line">cpan&gt; exit</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#方法二：（用时比较短）</span></span><br><span class="line">yum install perl-libwww-perl</span><br></pre></td></tr></table></figure>
]]></content>
    <summary type="html">
    <![CDATA[<p>公司用的 Cacti 监控平台已经有些时日了，一直运行很稳定，不过，昨天接到通知要迁移 Cacti 平台到别外的一台新服务器。以初以为直接把 Cacti 的 WEB 文件和数据库同步到新服务器就可以了，在实际操作的过程中发现并不是这样的。</p>]]>
    
    </summary>
    
      <category term="cacti" scheme="http://blog.tanchao.org/tags/cacti/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Test it]]></title>
    <link href="http://blog.tanchao.org/2010/01/05/test-it/"/>
    <id>http://blog.tanchao.org/2010/01/05/test-it/</id>
    <published>2010-01-05T02:53:50.000Z</published>
    <updated>2016-01-21T08:00:25.000Z</updated>
    <content type="html"><![CDATA[<p>一直纠结于哪里写博客，曾用过新浪博客，百度空间，JavaEye，LOFTER，OSChina，cnblogs，CSDN，自搭WordPress，都不满意。再后来也弄过Jekyll和Octopress，觉累不爱。</p>
<p>直到多看了一眼hexo，这个逼格极高的程序猿写作方式，我喜欢。就连 hexo 的发音都像是 黑客哦 ！如果你跟我一样纠结哪里写博，那就来到GitHub吧，让我们一起hexo！H人希绝对不会让你失望，相信很快hexo就会流行起来。</p>
<a id="more"></a>
<p>hexo出自台湾大学生 tommy351 之手，是一个基于<code>Node.js</code>的静态博客程序，其编译上百篇文字只需要几秒。hexo生成的静态网页可以直接放到GitHub Pages，BAE，SAE等平台上。先看看tommy是如何吐槽Octopress的 →＿→ Hexo颯爽登場 。</p>
<ul>
<li>如果你对默认配置满意，只需几个命令便可秒搭一个hexo。</li>
<li>如果你跟我一样喜欢折腾下，30分钟也足够个性化。</li>
<li>如果你过于喜欢折腾，可以折腾个把星期，尽情的玩。</li>
</ul>
]]></content>
    <summary type="html">
    <![CDATA[<p>一直纠结于哪里写博客，曾用过新浪博客，百度空间，JavaEye，LOFTER，OSChina，cnblogs，CSDN，自搭WordPress，都不满意。再后来也弄过Jekyll和Octopress，觉累不爱。</p>
<p>直到多看了一眼hexo，这个逼格极高的程序猿写作方式，我喜欢。就连 hexo 的发音都像是 黑客哦 ！如果你跟我一样纠结哪里写博，那就来到GitHub吧，让我们一起hexo！H人希绝对不会让你失望，相信很快hexo就会流行起来。</p>]]>
    
    </summary>
    
      <category term="test" scheme="http://blog.tanchao.org/tags/test/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Hello World]]></title>
    <link href="http://blog.tanchao.org/2010/01/05/hello-world/"/>
    <id>http://blog.tanchao.org/2010/01/05/hello-world/</id>
    <published>2010-01-05T02:52:50.000Z</published>
    <updated>2016-01-21T08:00:04.000Z</updated>
    <content type="html"><![CDATA[<p>Welcome to <a href="http://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick_Start"><a href="#Quick_Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create_a_new_post"><a href="#Create_a_new_post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run_server"><a href="#Run_server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<a id="more"></a>
<h3 id="Generate_static_files"><a href="#Generate_static_files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy_to_remote_sites"><a href="#Deploy_to_remote_sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>Welcome to <a href="http://hexo.io/">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick_Start"><a href="#Quick_Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create_a_new_post"><a href="#Create_a_new_post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run_server"><a href="#Run_server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="http://hexo.io/docs/server.html">Server</a></p>]]>
    
    </summary>
    
  </entry>
  
</feed>
